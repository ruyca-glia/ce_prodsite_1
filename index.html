<!DOCTYPE html>
<html>
  <head>
    <script async src="https://api.glia.com/salemove_integration.js"></script>

    <script>
      console.log("[Glia Debug] 1. Script parsed, setting up Glia waiter...");

      window.smReady = function() {
        console.log("[Glia Debug] 2. smReady() triggered. Requesting Glia API...");
        
        sm.getApi({ version: 'v1' }).then(function(salemove) {
          console.log("[Glia Debug] 3. sm.getApi() resolved. Glia API is available.");

          salemove.config.isCustomTheme = true;
          salemove.config.reactiveTabVisuals = {
            backColor: "#0000FF",
            frontColor: "#FF0000",
            fontSize: 14,
            format: "text",
            iconType: "text",
            placement: "right",
            size: 80,
            text: "Click Me!",
            verticalOffset: 100,
            visibleOperatorCount: 1
          };
          console.log("[Glia Debug] 4. SDK config applied.");

          // Helper function to safely attach our button listener
          function setupVideoButton() {
            console.log("[Glia Debug] 5. Searching for #start-video-btn in the DOM...");
            const videoBtn = document.getElementById('start-video-btn');
            
            if (videoBtn) {
              console.log("[Glia Debug] 6. SUCCESS! Button found. Attaching click listener.");
              videoBtn.addEventListener('click', function() {
                console.log("[Glia Debug] 7. BUTTON CLICKED! Requesting video engagement...");
                
                salemove.requestEngagement('video')
                  .then(function() {
                    console.log('[Glia Debug] 8. SUCCESS: Video engagement requested successfully!');
                  })
                  .catch(function(error) {
                    console.error('[Glia Debug] 8. ERROR: Failed to request video engagement:', error);
                  });
              });
            } else {
              console.warn("[Glia Debug] FAILURE: Could not find #start-video-btn. Check your HTML.");
            }
          }

          // Ensure the DOM is fully loaded before looking for the button
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupVideoButton);
          } else {
            setupVideoButton();
          }

        }).catch(function(err) {
          console.error("[Glia Debug] ERROR: Failed to get Glia API:", err);
        });
      };

      // BULLETPROOF FIX: Poll for window.sm instead of relying on the event listener
      function checkGliaReady() {
        if (window.sm && typeof window.sm.getApi === 'function') {
           console.log("[Glia Debug] window.sm found! Bootstrapping...");
           window.smReady();
        } else {
           // If not ready, wait 100ms and check again
           setTimeout(checkGliaReady, 100);
        }
      }

      // Start the polling
      checkGliaReady();
    </script>

    <title>CE Testing Site</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
      h1 { color:#7C19DD; font-family:roboto; text-align:center; }
      img { width:50%; display: block; margin: 0 auto; }
      .nav-container { text-align: center; margin-top: 20px; }
      .btn {
        padding: 10px 20px;
        background-color: #7C19DD;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-family: roboto, sans-serif;
        border: none;
        cursor: pointer;
        font-size: 16px;
      }
      .btn:hover { background-color: #5a12a3; }
    </style>
    <link rel="stylesheet" href="./static/css/styles.css">
    <script type="text/javascript" src="./static/js/client-app.js" defer></script>
  </head>

  <body>
    <center>
      <img src="images/Full LOGO_black.png" alt="CE logo" style="width:750px">
    </center>

    <h1 id="title" class="title">Welcome to our PROD site!</h1>

    <div class="nav-container">
      <button id="start-video-btn" class="btn">Start Video Engagement</button>
    </div>

    <div class="nav-container">
      <a href="/static/other_page.html" class="btn">Go to Cat Facts</a>
    </div>

    <div class="nav-container">
      <a href="./static/desafilacion.html" id="redirect-link" class="btn">Go to desafilacion</a>
    </div>

    <dialog id="tos-modal">
      <h2>Terms of service</h2>
      <p>By continuing, you agree to our terms and conditions.</p>
      <div class="actions">
        <button id="cancel-btn">Cancel</button>
        <button id="accept-btn">I accept</button>
      </div>
    </dialog>
  </body>
</html>