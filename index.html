<!DOCTYPE html>
<html>
  <head>
    <script async src="https://api.glia.com/salemove_integration.js"></script>

    <script>
      console.log("[Glia Debug] 1. Script parsed, setting up Glia waiter...");

      window.smReady = function() {
        console.log("[Glia Debug] 2. smReady() triggered. Requesting Glia API...");
        
        sm.getApi({ version: 'v1' }).then(function(salemove) {
          console.log("[Glia Debug] 3. sm.getApi() resolved. Glia API is available.");

          // MUST BE TRUE to allow us to embed the video in our own custom tags
          salemove.config.isCustomTheme = true; 
          
          // --- NEW: Listen for the Engagement to Start ---
          salemove.addEventListener(salemove.EVENTS.ENGAGEMENT_START, function(engagement) {
            console.log("[Glia Debug] Engagement Started! Listening for media streams...");
            
            // Unhide our custom video container on the page
            document.getElementById('embedded-video-container').style.display = 'block';

            // Listen for media stream updates (when cameras turn on/off)
            engagement.addEventListener(engagement.EVENTS.MEDIA_STATE_UPDATE, function(mediaState) {
              console.log("[Glia Debug] Media State Updated:", mediaState);
              
              const operatorVideo = document.getElementById('operator-video');
              const visitorVideo = document.getElementById('visitor-video');

              // --- 1. Handle Operator (Remote) Video ---
              if (mediaState.remoteVideo) {
                 // Safely attach the WebRTC stream to our <video> tag
                 operatorVideo.srcObject = mediaState.remoteVideo.stream || mediaState.remoteVideo;
                 operatorVideo.play().catch(e => console.error("Video play failed", e));
              } else {
                 // Operator turned off camera or hasn't connected it yet
                 operatorVideo.srcObject = null;
              }

              // --- 2. Handle Visitor (Local) Video ---
              if (mediaState.localVideo) {
                 visitorVideo.srcObject = mediaState.localVideo.stream || mediaState.localVideo;
                 visitorVideo.play().catch(e => console.error("Video play failed", e));
              } else {
                 visitorVideo.srcObject = null;
              }
            });
          });

          // Helper function to safely attach our button listener
          function setupVideoButton() {
            const videoBtn = document.getElementById('start-video-btn');
            if (videoBtn) {
              videoBtn.addEventListener('click', function() {
                console.log("[Glia Debug] Manual video button clicked...");
                
                // Request the video engagement
                salemove.requestEngagement('video')
                  .catch(function(error) {
                    console.error('[Glia Debug] ERROR:', error);
                  });
              });
            }
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupVideoButton);
          } else {
            setupVideoButton();
          }

        }).catch(function(err) {
          console.error("[Glia Debug] ERROR: Failed to get Glia API:", err);
        });
      };

      function checkGliaReady() {
        if (window.sm && typeof window.sm.getApi === 'function') {
           window.smReady();
        } else {
           setTimeout(checkGliaReady, 100);
        }
      }

      checkGliaReady();
    </script>

    <title>CE Testing Site</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
      h1 { color:#7C19DD; font-family:roboto; text-align:center; }
      img { width:50%; display: block; margin: 0 auto; }
      .nav-container { text-align: center; margin-top: 20px; }
      .btn {
        padding: 10px 20px;
        background-color: #7C19DD;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-family: roboto, sans-serif;
        border: none;
        cursor: pointer;
        font-size: 16px;
        display: inline-block;
        margin: 5px;
      }
      .btn:hover { opacity: 0.9; }

      /* --- NEW: Styling for our embedded video player --- */
      #embedded-video-container {
        display: none; /* Hidden until the call actually starts */
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        border: 3px solid #7C19DD;
        border-radius: 10px;
        background-color: #f9f9f9;
        text-align: center;
      }
      .video-wrapper {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
      }
      video {
        width: 45%;
        border-radius: 8px;
        background-color: #000; /* Black background while loading */
        box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      }
    </style>
    <link rel="stylesheet" href="./static/css/styles.css">
    <script type="text/javascript" src="./static/js/client-app.js" defer></script>
  </head>

  <body>
    <center>
      <img src="images/Full LOGO_black.png" alt="CE logo" style="width:750px">
    </center>

    <h1 id="title" class="title">Welcome to our PROD site!</h1>

    <div class="nav-container">
      <button id="start-video-btn" class="btn">Force Video API Call</button>
    </div>

    <div id="embedded-video-container">
      <h2 style="color: #7C19DD; margin-top: 0;">Live Video Call</h2>
      <div class="video-wrapper">
        <video id="operator-video" autoplay playsinline></video>
        <video id="visitor-video" autoplay playsinline muted></video>
      </div>
    </div>

    <div class="nav-container">
      <a href="/static/other_page.html" class="btn">Go to Cat Facts</a>
    </div>
    
    <div class="nav-container">
      <a href="./static/desafilacion.html" id="redirect-link" class="btn">Go to desafilacion</a>
    </div>

  </body>
</html>