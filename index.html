<!DOCTYPE html>
<html>
  <head>
    <script async src="https://api.glia.com/salemove_integration.js"></script>

    <script>
      window.smReady = function() {
        console.log("[Glia Debug] 2. smReady() triggered. Requesting Glia API...");
        
        sm.getApi({ version: 'v1' }).then(function(salemove) {
          console.log("[Glia Debug] 3. sm.getApi() resolved. Glia API is available.");

          salemove.config.isCustomTheme = true; 
          
          // --- THE SWISS ARMY KNIFE MEDIA ATTACHER ---
          function attachWebRTCStream(mediaObj, videoElement) {
            if (!mediaObj) {
              videoElement.srcObject = null;
              return;
            }

            console.log(`[Glia Debug] Attempting to attach media to ${videoElement.id}:`, mediaObj);

            // 1. Is it a standard WebRTC MediaStream?
            if (mediaObj instanceof MediaStream) {
              console.log("[Glia Debug] -> It's a MediaStream. Assigning to srcObject.");
              videoElement.srcObject = mediaObj;
            }
            // 2. Is it wrapped inside a 'stream' property?
            else if (mediaObj.stream && mediaObj.stream instanceof MediaStream) {
              console.log("[Glia Debug] -> It's a wrapped MediaStream. Assigning to srcObject.");
              videoElement.srcObject = mediaObj.stream;
            }
            // 3. Is it a Twilio-style Track object with an attach() method?
            else if (typeof mediaObj.attach === 'function') {
              console.log("[Glia Debug] -> It's a Track object with an attach() method. Executing...");
              // Twilio attaches the stream and returns a new <video> element
              const newVideoElement = mediaObj.attach();
              // Make sure the new element has our classes/styles if needed
              newVideoElement.style.width = '45%';
              newVideoElement.style.borderRadius = '8px';
              videoElement.replaceWith(newVideoElement); 
            }
            // 4. Did Glia already build the HTML <video> element for us?
            else if (mediaObj instanceof HTMLElement) {
              console.log("[Glia Debug] -> It's a pre-built HTML Element. Swapping it into the DOM.");
              mediaObj.style.width = '45%';
              mediaObj.style.borderRadius = '8px';
              videoElement.replaceWith(mediaObj);
            }
            // 5. Unrecognized Format
            else {
              console.warn("[Glia Debug] -> UNRECOGNIZED media format! The screen will stay black.", mediaObj);
            }
            
            // Give the browser a gentle nudge to play
            if (videoElement.play) {
                videoElement.play().catch(e => console.error("Autoplay prevented:", e));
            }
          }

          salemove.addEventListener(salemove.EVENTS.ENGAGEMENT_START, function(engagement) {
            console.log("[Glia Debug] Engagement Started! Unhiding video container...");
            document.getElementById('embedded-video-container').style.display = 'block';

            engagement.addEventListener(engagement.EVENTS.MEDIA_STATE_UPDATE, function(mediaState) {
              console.log("[Glia Debug] RAW Media State Updated:", mediaState);
              
              const operatorVideo = document.getElementById('operator-video');
              const visitorVideo = document.getElementById('visitor-video');

              // Use our robust attacher function
              attachWebRTCStream(mediaState.remoteVideo, operatorVideo);
              attachWebRTCStream(mediaState.localVideo, visitorVideo);
            });
          });

          function setupVideoButton() {
            const videoBtn = document.getElementById('start-video-btn');
            if (videoBtn) {
              videoBtn.addEventListener('click', function() {
                salemove.requestEngagement('video').catch(e => console.error(e));
              });
            }
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupVideoButton);
          } else {
            setupVideoButton();
          }

        }).catch(function(err) {
          console.error("[Glia Debug] ERROR: Failed to get Glia API:", err);
        });
      };
    </script>

    <title>CE Testing Site</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
      h1 { color:#7C19DD; font-family:roboto; text-align:center; }
      img { width:50%; display: block; margin: 0 auto; }
      .nav-container { text-align: center; margin-top: 20px; }
      .btn {
        padding: 10px 20px;
        background-color: #7C19DD;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-family: roboto, sans-serif;
        border: none;
        cursor: pointer;
        font-size: 16px;
        display: inline-block;
        margin: 5px;
      }
      .btn:hover { opacity: 0.9; }

      /* --- NEW: Styling for our embedded video player --- */
      #embedded-video-container {
        display: none; /* Hidden until the call actually starts */
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        border: 3px solid #7C19DD;
        border-radius: 10px;
        background-color: #f9f9f9;
        text-align: center;
      }
      .video-wrapper {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
      }
      video {
        width: 45%;
        border-radius: 8px;
        background-color: #000; /* Black background while loading */
        box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
      }
    </style>
    <link rel="stylesheet" href="./static/css/styles.css">
    <script type="text/javascript" src="./static/js/client-app.js" defer></script>
  </head>

  <body>
    <center>
      <img src="images/Full LOGO_black.png" alt="CE logo" style="width:750px">
    </center>

    <h1 id="title" class="title">Welcome to our PROD site!</h1>

    <div class="nav-container">
      <button id="start-video-btn" class="btn">Force Video API Call</button>
    </div>

    <div id="embedded-video-container">
      <h2 style="color: #7C19DD; margin-top: 0;">Live Video Call</h2>
      <div class="video-wrapper">
        <video id="operator-video" autoplay playsinline></video>
        <video id="visitor-video" autoplay playsinline muted></video>
      </div>
    </div>

    <div class="nav-container">
      <a href="/static/other_page.html" class="btn">Go to Cat Facts</a>
    </div>
    
    <div class="nav-container">
      <a href="./static/desafilacion.html" id="redirect-link" class="btn">Go to desafilacion</a>
    </div>

  </body>
</html>